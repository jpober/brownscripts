#!/bin/env python

from astropy.io import fits
from astropy.time import Time
import aipy as a
import sys, optparse, csv
import numpy as n
import ephem
from uvdata.uv import UVData, UVParameter

def decdeg2dms(dd):
    if dd < 0: dp = -dd
    else: dp = dd
    mnt,sec=divmod(dp*3600,60)
    deg,mnt=divmod(mnt,60)
    if dd<0: return str(-int(deg))+':'+str(int(mnt))+':'+str(sec)
    else: return str(int(deg))+':'+str(int(mnt))+':'+str(sec)

d1 = '0,2,4,6,0,2,4,6,0,2,4,6,0,2,4,6'
d2 = '0,1,2,3,0,1,2,3,0,1,2,3,0,1,2,3'
d3 = '0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0'
d4 = '3,2,1,0,3,2,1,0,3,2,1,0,3,2,1,0'
d5 = '6,4,2,0,6,4,2,0,6,4,2,0,6,4,2,0'
d6 = '9,6,3,0,9,6,3,0,9,6,3,0,9,6,3,0'
delaylist = [d1]*16+[d2]*15+[d3]*15+[d4]*15+[d5]*15+[d6]*18
timelist = [(2456528.1996296346, 2456528.2009027898, 2.3148276589133523e-05),
(2456528.2010185122, 2456528.2022916675, 2.3148276589133523e-05),
(2456528.2024074197, 2456528.2036805451, 2.3147734728726475e-05),
(2456528.2038888931, 2456528.2051620483, 2.3148276589133523e-05),
(2456528.2052777708, 2456528.206550926, 2.3148276589133523e-05),
(2456528.2066666782, 2456528.2079398036, 2.3147734728726475e-05),
(2456528.2080555558, 2456528.209328711, 2.3148276589133523e-05),
(2456528.2095370293, 2456528.2108101845, 2.3148276589133523e-05),
(2456528.2109259367, 2456528.2121990621, 2.3147734728726475e-05),
(2456528.2123148143, 2456528.2135879695, 2.3148276589133523e-05),
(2456528.213703692, 2456528.2149768472, 2.3148276589133523e-05),
(2456528.2151851952, 2456528.2164583206, 2.3147734728726475e-05),
(2456528.2165740728, 2456528.2178472281, 2.3148276589133523e-05),
(2456528.2179629505, 2456528.2192361057, 2.3148276589133523e-05),
(2456528.2193518579, 2456528.2206250131, 2.3148276589133523e-05),
(2456528.2208333313, 2456528.2221064866, 2.3148276589133523e-05),
(2456528.222222209, 2456528.2234953642, 2.3148276589133523e-05),
(2456528.2236111164, 2456528.2248842716, 2.3148276589133523e-05),
(2456528.224999994, 2456528.2262731493, 2.3148276589133523e-05),
(2456528.2264814675, 2456528.2277546227, 2.3148276589133523e-05),
(2456528.2278703749, 2456528.2291435301, 2.3148276589133523e-05),
(2456528.2292592525, 2456528.2305324078, 2.3148276589133523e-05),
(2456528.23064816, 2456528.2319212854, 2.3147734728726475e-05),
(2456528.2321296334, 2456528.2334027886, 2.3148276589133523e-05),
(2456528.2335185111, 2456528.2347916663, 2.3148276589133523e-05),
(2456528.2349074185, 2456528.2361805439, 2.3147734728726475e-05),
(2456528.2362962961, 2456528.2375694513, 2.3148276589133523e-05),
(2456528.2377777696, 2456528.2390509248, 2.3148276589133523e-05),
(2456528.239166677, 2456528.2404398024, 2.3147734728726475e-05),
(2456528.2405555546, 2456528.2418287098, 2.3148276589133523e-05),
(2456528.2419444323, 2456528.2432175875, 2.3148276589133523e-05),
(2456528.2434259355, 2456528.2446990609, 2.3147734728726475e-05),
(2456528.2448148131, 2456528.2460879683, 2.3148276589133523e-05),
(2456528.2462036908, 2456528.247476846, 2.3148276589133523e-05),
(2456528.2475925982, 2456528.2488657534, 2.3148276589133523e-05),
(2456528.2490740716, 2456528.2503472269, 2.3148276589133523e-05),
(2456528.2504629642, 2456528.2517361045, 2.3148005658929999e-05),
(2456528.2518518567, 2456528.253124997, 2.3148005658929999e-05),
(2456528.2532407343, 2456528.2545138896, 2.3148276589133523e-05),
(2456528.2547222227, 2456528.255995363, 2.3148005658929999e-05),
(2456528.2561111152, 2456528.2573842555, 2.3148005658929999e-05),
(2456528.2574999928, 2456528.2587731481, 2.3148276589133523e-05),
(2456528.2588888854, 2456528.2601620406, 2.3148276589133523e-05),
(2456528.2603703737, 2456528.261643514, 2.3148005658929999e-05),
(2456528.2617592663, 2456528.2630324066, 2.3148005658929999e-05),
(2456528.2631481439, 2456528.2644212991, 2.3148276589133523e-05),
(2456528.2645370364, 2456528.2658101916, 2.3148276589133523e-05),
(2456528.2660185248, 2456528.2672916651, 2.3148005658929999e-05),
(2456528.2674074024, 2456528.2686805576, 2.3148276589133523e-05),
(2456528.2687962949, 2456528.2700694501, 2.3148276589133523e-05),
(2456528.2701851875, 2456528.2714583278, 2.3148005658929999e-05),
(2456528.2716666609, 2456528.2729398161, 2.3148276589133523e-05),
(2456528.2730555534, 2456528.2743287086, 2.3148276589133523e-05),
(2456528.274444446, 2456528.2757175863, 2.3148005658929999e-05),
(2456528.2758333385, 2456528.2771064788, 2.3148005658929999e-05),
(2456528.2773148119, 2456528.2785879672, 2.3148276589133523e-05),
(2456528.2787037045, 2456528.2799768448, 2.3148005658929999e-05),
(2456528.280092597, 2456528.2813657373, 2.3148005658929999e-05),
(2456528.2814814746, 2456528.2827546299, 2.3148276589133523e-05),
(2456528.282962963, 2456528.2842361182, 2.3148276589133523e-05),
(2456528.2843518555, 2456528.2856249958, 2.3148005658929999e-05),
(2456528.2857407331, 2456528.2870138884, 2.3148276589133523e-05),
(2456528.2871296257, 2456528.2884027809, 2.3148276589133523e-05),
(2456528.288611114, 2456528.2898842543, 2.3148005658929999e-05),
(2456528.2900000066, 2456528.2912731469, 2.3148005658929999e-05),
(2456528.2913888842, 2456528.2926620394, 2.3148276589133523e-05),
(2456528.2927777767, 2456528.2940509319, 2.3148276589133523e-05),
(2456528.2942592651, 2456528.2955324054, 2.3148005658929999e-05),
(2456528.2956481427, 2456528.2969212979, 2.3148276589133523e-05),
(2456528.2970370352, 2456528.2983101904, 2.3148276589133523e-05),
(2456528.2984259278, 2456528.2996990681, 2.3148005658929999e-05),
(2456528.2999074012, 2456528.3011805564, 2.3148276589133523e-05),
(2456528.3012962937, 2456528.3025694489, 2.3148276589133523e-05),
(2456528.3026851863, 2456528.3039583266, 2.3148005658929999e-05),
(2456528.3040740788, 2456528.3053472191, 2.3148005658929999e-05),
(2456528.3055555522, 2456528.3068287075, 2.3148276589133523e-05),
(2456528.3069444448, 2456528.3082175851, 2.3148005658929999e-05),
(2456528.3083333373, 2456528.3096064776, 2.3148005658929999e-05),
(2456528.3097222149, 2456528.3109953701, 2.3148276589133523e-05),
(2456528.3112037033, 2456528.3124768585, 2.3148276589133523e-05),
(2456528.3125925958, 2456528.3138657361, 2.3148005658929999e-05),
(2456528.3139814883, 2456528.3152546287, 2.3148005658929999e-05),
(2456528.315370366, 2456528.3166435212, 2.3148276589133523e-05),
(2456528.3168518543, 2456528.3181249946, 2.3148005658929999e-05),
(2456528.3182407469, 2456528.3195138872, 2.3148005658929999e-05),
(2456528.3196296245, 2456528.3209027797, 2.3148276589133523e-05),
(2456528.321018517, 2456528.3222916722, 2.3148276589133523e-05),
(2456528.3225000054, 2456528.3237731457, 2.3148005658929999e-05),
(2456528.323888883, 2456528.3251620382, 2.3148276589133523e-05),
(2456528.3252777755, 2456528.3265509307, 2.3148276589133523e-05),
(2456528.3266666681, 2456528.3279398084, 2.3148005658929999e-05),
(2456528.3281481415, 2456528.3294212967, 2.3148276589133523e-05),
(2456528.329537034, 2456528.3308101892, 2.3148276589133523e-05),
(2456528.3309259266, 2456528.3321990669, 2.3148005658929999e-05)]

RAlist = [355.7747416798699,
 356.2764481557374,
 356.7781830979642,
 357.3133366733206,
 357.8150733065082,
 358.3167830879389,
 358.8185209542662,
 359.3536780792277,
 359.8554085924123,
 0.3571325760772602,
 0.8588570209470606,
 1.3940298708495,
 1.895754640387602,
 2.397479889200486,
 2.899204944525079,
 3.434379000398047,
 356.2622658470658,
 356.7639825860167,
 357.2657277679912,
 357.8008922468393,
 358.3026387849658,
 358.8043590054173,
 359.3061070086476,
 359.8412781183658,
 0.3430114008402328,
 0.8447447894349475,
 1.346478500841574,
 1.881661637666322,
 2.383395829809858,
 2.885130148169588,
 3.386864667899797,
 356.3038382582308,
 356.8055857896703,
 357.3073065338226,
 357.80905542086,
 358.3442243890356,
 358.8459748440076,
 359.34769868155,
 359.8494338190942,
 0.3846190644417725,
 0.8863557388661116,
 1.388092505092876,
 1.88982950720896,
 2.425015931293939,
 2.926753343844366,
 3.428491012285335,
 356.3120171014037,
 356.8471900834547,
 357.348929291076,
 357.8506697826101,
 358.3523832181399,
 358.8875873394217,
 359.3893022997333,
 359.8910411529602,
 0.3927744324354322,
 0.9279567460803007,
 1.429690487899068,
 1.931424621328283,
 2.433158800085693,
 2.968342116862803,
 3.470076475698106,
 356.2979731701596,
 356.7996748960408,
 357.3348659453688,
 357.8365692898507,
 358.3383008024638,
 358.8400328929332,
 359.3751998961305,
 359.8769181779305,
 0.3786421132368082,
 0.8803663258642238,
 1.415539214586308,
 1.917264077161869,
 2.418988933198115,
 2.92071413861356,
 3.45588779305723,
 356.1598432935251,
 356.66155591122,
 357.1632420147617,
 357.6984171544369,
 358.2001048831038,
 358.7018206908715,
 359.2035376031143,
 359.7386881100908,
 0.2403946022632056,
 0.7421034552278809,
 1.243812339405027,
 1.778969056294653,
 2.280678446367146,
 2.782388133879986,
 3.284098155471878,
 3.819255570503198,
 4.320965585445152,
 4.822675828634868]

DEClist = [-25.96440923165652,
 -25.96445713758903,
 -25.96450043872224,
 -25.96453832505396,
 -25.96456710382853,
 -25.96459150336854,
 -25.96460969720478,
 -25.96462225526444,
 -25.9646276175542,
 -25.96462677005856,
 -25.96461959363735,
 -25.96460533564646,
 -25.96458715420021,
 -25.96456093921331,
 -25.96453034571866,
 -25.96449075695374,
 -26.58037965217246,
 -26.58042234560487,
 -26.58046042697623,
 -26.58049273884796,
 -26.58051640402648,
 -26.58053544645961,
 -26.58054668921665,
 -26.58055376829496,
 -26.58055375844145,
 -26.58054765402211,
 -26.58053533621952,
 -26.58051534437507,
 -26.58049189625293,
 -26.58046041229938,
 -26.5804245478187,
 -26.78347202115501,
 -26.78351435268676,
 -26.78355059766967,
 -26.78358234490085,
 -26.78360765045253,
 -26.78362485500215,
 -26.78363755342135,
 -26.78364391874284,
 -26.78364239177672,
 -26.78363591308383,
 -26.78362333899589,
 -26.78360455119787,
 -26.78357936577551,
 -26.78354774106804,
 -26.78351161569386,
 -26.58038369893068,
 -26.58042860240856,
 -26.58046407755443,
 -26.58049493536289,
 -26.58051799556159,
 -26.58053585791104,
 -26.5805477900263,
 -26.58055350965854,
 -26.58055289673568,
 -26.58054563531007,
 -26.58053230088981,
 -26.58051263528075,
 -26.58048687806837,
 -26.58045438153886,
 -26.58041567633605,
 -25.96445774613692,
 -25.96449909364679,
 -25.96453843022946,
 -25.96456708359223,
 -25.96459112252485,
 -25.9646090742525,
 -25.964619786562,
 -25.96462478875087,
 -25.96462370095679,
 -25.9646181114369,
 -25.9646034792171,
 -25.9645833517346,
 -25.96455872538269,
 -25.96452777555406,
 -25.96448634585424,
 -24.91387505207776,
 -24.91391685215951,
 -24.91395416672596,
 -24.91398713871044,
 -24.91401164950478,
 -24.91402996251302,
 -24.91404195574739,
 -24.91404986125075,
 -24.91404915642058,
 -24.91404383778373,
 -24.91403072905496,
 -24.91401161393318,
 -24.91398739910824,
 -24.91395698673738,
 -24.9139202602099,
 -24.91387438688075,
 -24.91382669291075,
 -24.91377098766836]


## NB -- pyuvdata and uvfits use Hz and Seconds for everything. AIPY assumes GHz and ns.

#Parallel version of uvfits_zeros_gen


o = optparse.OptionParser()
o.set_usage('uvfits_zeros_gen [-o <outfile>] <cal file of coords> <sim_settings_file>')

o.add_option('-o', dest='ofile', help='Destination filename')
o.add_option('-i', dest='en', help='Which job?')
o.add_option('-N', dest='nout', help='How many?')

opts,args = o.parse_args(sys.argv[1:])

if not opts.ofile == None:
    ofile=opts.ofile
else:
    ofile='empty.uvfits'
if not opts.en == None:
    en=int(opts.en)
else:
    en=1
if not opts.nout == None:
    nout=opts.nout
else:
    nout=1


#Import the sim and instrument settings from the file.
exec('from %s import sim_prms as _sim_params' % args[0].split('.')[0] )
exec('from %s import instr_prms as _instr_params' % args[0].split('.')[0] )
	
uvd = UVData()

default_attrs=[aa for aa in dir(uvd) if not aa.startswith('__')]
#default_attrs.append("delays")

for key, val in _sim_params.iteritems():
    if key in default_attrs:
	uvp = getattr(uvd, key)
    else:
        uvp = UVParameter(key)
    uvp = val
    setattr(uvd,key,uvp)
for key, val in _instr_params.iteritems():
    if key in default_attrs:
	uvp = getattr(uvd, key)
    else:
        uvp = UVParameter(key)
    uvp = val
    setattr(uvd,key,uvp)

#print 'check:', uvd.channel_width, uvd.sfreq
# Generate an antenna array from a cal file.
aa = a.cal.get_aa(args[1].split('.')[0], uvd.channel_width/1e9, uvd.sfreq/1e9, uvd.Nfreqs)  #Saved in Hz, AIPY expects GHz
Nants = len(aa)

uvd.Nants_telescope = Nants
uvd.Nants_data = Nants
uvd.latitude, uvd.longitude, uvd.altitude = aa.lat, aa.long, aa.elev    ### Altitude vs elevation?

uvd.channel_width = uvd.channel_width

polar = uvd.polarization_array

if polar == 'stokes':
    uvd.polarization_array=n.arange(1,5,1)
elif polar == 'circ':
    uvd.polarization_array=n.arange(-1,-5,-1)
elif polar == 'lin':
    uvd.polarization_array=n.arange(-5,-9,-1)


#Time -- The rest of this uses julian date. Take param from sim_prms (in uvd) and 
# convert to ephem object. Then use that to get julian date.

if uvd.time_format == 'julian':
    tzero = ephem.date(uvd.start_time - 2415020.)
    tfin = ephem.date(uvd.end_time - 2415020.)

tzero = ephem.julian_date(tzero)
tfin = ephem.julian_date(tfin)

uvd.dateobs = tzero
#dt = (tfin - tzero)/ float(uvd.Ntimes * int(nout))
dt = timelist[en-1][2]

try:
   uvd.x_telescope, uvd.y_telescope, uvd.z_telescope = aa.get_xyz_telescope()
except AttributeError:
   pass

#Frequency array
uvd.freq_array = n.array([aa.get_afreqs()* 1e9])

#Baseline array:
ant_exclude=[]
if hasattr(uvd,'bad_antenna'):
	ant_exclude = uvd.bad_antenna          #List antennas to be excluded here, for whatever reason.
bls = n.array([uvd.antnums_to_baseline(j,i,attempt256=True) 
       for i in range(0,len(aa)) 
       for j in range(i,len(aa)) if not j in ant_exclude and not i in ant_exclude ])

uvd.baseline_array = n.tile(bls, uvd.Ntimes)

#number of baselines
nbl = len(bls)
uvd.Nbls = nbl

#Antennas
uvd.antenna_indices = n.arange(1,Nants+1,1)       #1 indexed, not 0
uvd.antenna_names = ["ANT"+str(i) for i in uvd.antenna_indices]
uvd.antenna_positions = n.array([ant.pos for ant in aa])
uvd.ant_1_array, uvd.ant_2_array = \
          uvd.baseline_to_antnums(uvd.baseline_array)

#Delays
if uvd.instrument == 'MWA':
	uvd.extra_keywords['delays'] = d3

#t0 = tzero+(en-1)*uvd.Ntimes*dt
t0 = timelist[en-1][0]
#Data array
uvd.data_array = n.zeros((nbl * uvd.Ntimes, uvd.Nspws, uvd.Nfreqs, uvd.Npols), dtype=n.complex)

#Time array:
## Format -- Repeat times for each baseline number.

tims = n.arange(uvd.Ntimes, dtype=n.float) * dt + t0
uvd.time_array = n.sort(n.tile(tims, nbl))    #Should be of length Nblts, baseline fast time slow
uvd.Nblts = len(uvd.time_array)    #nbls * Ntimes

t = t0 + dt
#t0 = max(tims)
aa.set_jultime(t)
RA0 = RAlist[en-1]*3.14159265358979323846/180.
DEC0 = DEClist[en-1]
RA = ephem.hours(RA0)
dec = decdeg2dms(DEC0)
#RA = str(aa.sidereal_time())
#dec = str(aa.lat)
src = str(RA)+'_'+dec

#Artificial point
#src="23:43:06.0_-25:57:51.84"
RA,dec = src.split('_')
print src
#sys.exit()


#uvd.phase_center_ra.value= n.rad2deg(float(repr(ephem.hours(RA))))
#uvd.phase_center_dec.value  = n.rad2deg(float(repr(ephem.degrees(dec))))
uvd.phase_center_ra= ephem.hours(RA)
uvd.phase_center_dec  = ephem.degrees(dec)
uvd.object_name= "zenith"
uvd.phase_center_epoch = 2000.
uvd.history = ''

srclist,cutoff,catalogs = a.scripting.parse_srcs(src, 'helm')
src = a.cal.get_catalog(args[0], srclist, cutoff, catalogs).values()[0]
#src._epoch=36525.
uvw_array = []
curtime=-1
for t in tims:
	if curtime != t:
		curtime = t
		aa.set_jultime(t)
	src.compute(aa)
	for bl in bls:
		i,j = aa.bl2ij(bl)
		uvw_array.append(aa.get_baseline(i,j,src=src))

uvd.uvw_array = n.array(uvw_array).T * a.const.len_ns / 100.


del uvw_array

#TODO --- Check line below. uvd needs a flag array. True = flagged
uvd.flag_array = n.zeros(shape=uvd.data_array.shape, dtype=n.bool)
uvd.nsample_array = n.ones(shape=uvd.data_array.shape, dtype=n.intc)

extra_attrs=[atr for atr in dir(uvd) if not atr.startswith('__') if not atr in default_attrs]

for attr in extra_attrs:
		delattr(uvd, attr)

#uvd.instrument.expected_type=str
#delattr(uvd, 'end_time')
uvd.set_lsts_from_time_array()
#uvd.lst_array.value = n.zeros(uvd.Ntimes.value*nbl)
if nout > 1:
     ofi = ofile.split(".")[0] +"_"  +  str(en) + ".uvfits"
print ofi
uvd.write_uvfits(ofi, spoof_nonessential=True)

hdu = fits.open(ofi,mode='update')
hdu[0].header['DELAYS'] = delaylist[en-1]
hdu.flush()
hdu.close()
