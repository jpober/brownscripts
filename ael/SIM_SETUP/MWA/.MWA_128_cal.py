
import aipy as a, numpy as n

class AntennaArray(a.pol.AntennaArray):
    def __init__(self, *args, **kwargs):
        a.pol.AntennaArray.__init__(self, *args, **kwargs)
        self.ant_layout = kwargs.pop('ant_layout')


prms = {
    'loc': ('-26:42:11.916', '116:40:15.06'), # MWA,  (GPS)
    'ant_layout': n.arange(0,128), 
    'antpos': {        
        0: [467101.60,7046644.69,377.02],
        1: [467155.98,7046649.21,377.29],
        2: [467162.84,7046645.06,377.32],
        3: [467172.67,7046637.50,377.30],
        4: [467164.45,7046627.50,377.34],
        5: [467149.09,7046623.10,377.26],
        6: [467158.07,7046621.32,377.28],
        7: [467103.17,7046599.18,377.22],
        8: [467118.39,7046661.53,377.01],
        9: [467111.48,7046654.40,377.03],
        10: [467127.65,7046663.79,377.06],
        11: [467158.42,7046660.38,377.26],
        12: [467173.47,7046661.90,377.26],
        13: [467167.84,7046656.61,377.31],
        14: [467174.34,7046651.70,377.30],
        15: [467075.33,7046668.70,376.63],
        16: [467227.86,7046580.78,376.81],
        17: [467227.63,7046601.58,376.88],
        18: [467210.92,7046614.35,376.97],
        19: [467196.88,7046616.66,377.13],
        20: [467186.53,7046629.92,377.24],
        21: [467181.28,7046638.49,377.27],
        22: [467191.28,7046642.79,377.19],
        23: [467200.66,7046643.68,377.11],
        24: [467183.34,7046650.19,377.24],
        25: [467191.26,7046651.01,377.21],
        26: [467180.42,7046657.89,377.26],
        27: [467205.77,7046652.39,377.07],
        28: [467198.15,7046655.39,377.10],
        29: [467228.66,7046642.90,376.95],
        30: [467196.19,7046663.40,377.19],
        31: [467236.39,7046653.09,376.92],
        32: [467196.14,7046504.00,376.80],
        33: [467429.48,7046336.50,375.01],
        34: [467230.09,7046456.31,376.35],
        35: [467343.96,7046299.11,375.76],
        36: [467406.28,7046120.00,376.48],
        37: [467184.50,7046356.88,376.18],
        38: [467134.12,7046339.24,376.06],
        39: [467164.20,7046504.31,377.03],
        40: [467146.20,7046596.20,377.26],
        41: [467152.92,7046609.19,377.27],
        42: [467169.60,7046608.41,377.28],
        43: [467171.88,7046617.20,377.28],
        44: [467176.27,7046626.08,377.26],
        45: [467180.40,7046615.03,377.24],
        46: [467188.87,7046608.11,377.21],
        47: [467200.75,7046601.04,377.08],
        48: [467055.62,7046568.59,377.17],
        49: [467053.65,7046473.99,377.03],
        50: [466968.19,7046182.59,374.91],
        51: [466864.15,7046334.40,375.38],
        52: [466799.58,7046362.31,375.13],
        53: [466782.93,7046563.28,374.77],
        54: [466887.18,7046561.47,375.75],
        55: [466881.88,7046644.80,375.26],
        56: [467090.13,7046951.90,374.80],
        57: [467123.11,7046729.39,376.58],
        58: [467181.50,7046673.10,377.20],
        59: [467172.53,7046676.31,377.20],
        60: [467147.33,7046679.89,377.06],
        61: [467151.12,7046667.89,377.16],
        62: [466855.78,7046749.34,374.54],
        63: [466987.57,7046767.80,375.34],
        64: [467577.44,7046583.75,373.96],
        65: [467424.83,7046573.35,375.04],
        66: [467248.72,7046672.09,376.90],
        67: [467204.72,7046666.60,377.12],
        68: [467195.12,7046675.03,377.16],
        69: [467217.40,7046730.18,376.99],
        70: [467300.71,7046915.42,376.20],
        71: [467335.49,7046898.50,376.34],
        72: [466732.58,7047010.25,372.66],
        73: [466760.74,7046982.40,372.96],
        74: [466675.66,7046792.71,373.41],
        75: [466666.88,7046276.41,375.24],
        76: [466598.49,7046519.90,374.50],
        77: [466566.76,7046589.69,374.28],
        78: [466172.72,7046463.59,377.10],
        79: [466224.96,7046950.99,374.15],
        80: [466914.12,7048038.43,371.29],
        81: [467022.64,7047276.49,373.76],
        82: [467076.35,7047160.19,374.27],
        83: [466992.87,7047270.29,373.56],
        84: [467055.10,7047141.40,374.14],
        85: [467000.58,7047110.09,373.84],
        86: [466949.63,7047082.59,373.56],
        87: [466360.16,7047464.69,370.54],
        88: [467964.39,7047785.79,374.80],
        89: [467538.32,7046998.10,375.17],
        90: [467488.20,7047148.04,375.86],
        91: [467477.64,7047199.30,375.81],
        92: [467311.30,7047194.40,376.05],
        93: [467191.06,7047189.37,375.22],
        94: [467284.75,7047329.25,376.35],
        95: [467249.36,7047791.05,373.84],
        96: [468088.95,7047371.29,372.83],
        97: [468426.47,7047240.63,372.29],
        98: [468563.51,7046935.88,370.51],
        99: [467807.20,7046625.20,372.31],
        100: [467822.32,7046739.90,372.55],
        101: [467739.50,7046805.43,373.00],
        102: [467778.93,7046919.69,372.83],
        103: [467631.18,7047032.92,374.30],
        104: [468351.99,7046533.93,369.16],
        105: [468453.66,7045939.48,368.46],
        106: [467751.05,7046116.23,373.25],
        107: [467553.16,7046331.25,374.63],
        108: [467622.55,7046341.96,374.35],
        109: [467796.27,7046289.70,372.84],
        110: [467758.54,7046377.49,372.82],
        111: [467775.26,7046456.21,372.64],
        112: [467908.11,7045343.87,371.19],
        113: [467696.91,7045545.66,372.32],
        114: [467194.52,7045874.17,372.93],
        115: [467290.08,7045974.65,374.05],
        116: [467485.64,7046022.29,375.28],
        117: [467510.79,7046013.80,375.24],
        118: [467578.34,7046061.90,375.05],
        119: [467578.72,7046074.09,375.14],
        120: [466840.80,7045969.48,374.00],
        121: [467111.25,7045958.99,373.52],
        122: [466774.07,7045561.25,375.79],
        123: [466678.98,7045514.57,375.61],
        124: [466579.96,7045739.12,375.41],
        125: [466621.54,7046132.79,375.58],
        126: [466619.51,7046208.49,375.65],
        127: [466684.41,7046120.40,375.28]
	}
}


def get_aa(freqs):
    '''Return the AntennaArray to be used for simulation.'''
    location = prms['loc']
    antennas = []
    phsoff = {'x':[0.,0.], 'y':[0.,0.]}
    nants = len(prms['antpos'])
    for i in range(nants):
        bp_r = {'x':n.array([0.0]*9), 'y':n.array([0.0]*9)}
        bp_i = {'x':n.array([0.0]*3), 'y':n.array([0.0]*3)}
        pos = prms['antpos'][i]
        antennas.append(a.pol.Antenna(pos[0], pos[1], pos[2], a.fit.Beam(freqs),
             amp={'x':1.,'y':1.},bp_r=bp_r, bp_i=bp_i, phsoff=phsoff))
    aa = AntennaArray(prms['loc'], antennas, ant_layout=prms['ant_layout'])
    #for i in range(nants):
    #    pos = prms['antpos-top'][i]
    #    i = str(i)
    #    aa.set_params({i:{'top_x':pos[0], 'top_y':pos[1], 'top_z':pos[2]}})
    return aa

